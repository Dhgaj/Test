{% extends "base.html" %} 

{% block content %}
<div class="container-fluid">
  <!-- 页面标题 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient border-0">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="mb-2 text-white">
                <i class="fas fa-users me-3"></i>用户管理
              </h2>
              <p class="mb-0 text-white-50">管理系统用户，分配权限和角色</p>
            </div>
            <div class="col-md-4 text-end">
              <div class="d-flex gap-2 justify-content-end flex-wrap">
                <a href="{{ url_for('admin_add_user') }}" class="btn btn-light btn-lg">
                  <i class="fas fa-user-plus me-2"></i>添加用户
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-lg">
                  <i class="fas fa-arrow-left me-2"></i>返回控制面板
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 统计概览 -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="stat-icon text-primary mb-3">
            <i class="fas fa-users fa-3x"></i>
          </div>
          <h3 class="fw-bold text-primary">{{ users|length }}</h3>
          <p class="text-muted mb-0">总用户数</p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="stat-icon text-danger mb-3">
            <i class="fas fa-user-shield fa-3x"></i>
          </div>
          <h3 class="fw-bold text-danger">{{ users|selectattr('is_admin')|list|length }}</h3>
          <p class="text-muted mb-0">管理员</p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="stat-icon text-success mb-3">
            <i class="fas fa-user fa-3x"></i>
          </div>
          <h3 class="fw-bold text-success">{{ users|rejectattr('is_admin')|list|length }}</h3>
          <p class="text-muted mb-0">普通用户</p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="stat-icon text-info mb-3">
            <i class="fas fa-user-cog fa-3x"></i>
          </div>
          <h3 class="fw-bold text-info">{{ users|length - 1 }}</h3>
          <p class="text-muted mb-0">可管理用户</p>
        </div>
      </div>
    </div>
  </div>

<style>
/* 确保与控制面板和预订页面的样式一致 */
.bg-gradient {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3) !important;
}

.bg-gradient-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.stat-card {
  border-left: 4px solid transparent;
  transition: all 0.3s ease;
  border-radius: 1rem !important;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 2rem rgba(0,0,0,0.1) !important;
}

.stat-card:nth-child(1) { border-left-color: #007bff; }
.stat-card:nth-child(2) { border-left-color: #dc3545; }
.stat-card:nth-child(3) { border-left-color: #28a745; }
.stat-card:nth-child(4) { border-left-color: #0dcaf0; }

.user-row {
  transition: all 0.3s ease;
}

.user-row:hover {
  background-color: rgba(102, 126, 234, 0.05);
  transform: translateX(5px);
}

.user-card {
  border-radius: 1rem !important;
  transition: all 0.3s ease;
  overflow: hidden;
}

.user-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 1rem 3rem rgba(0,0,0,0.15) !important;
}

.user-card .card-header {
  border-radius: 1rem 1rem 0 0 !important;
}

.user-name {
  font-weight: 600;
  margin: 0;
  font-size: 1.1rem;
}

.user-id {
  color: #6c757d;
  font-size: 0.9rem;
  margin: 0;
}

.stat-icon {
  width: 70px;
  height: 70px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  color: currentColor;
}

.info-item {
  display: flex;
  align-items: center;
  font-size: 0.9rem;
}

.info-item i {
  width: 20px;
  flex-shrink: 0;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 1.2rem;
  text-transform: uppercase;
  overflow: hidden;
  flex-shrink: 0;
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

/* 卡片视图中的头像稍大一些 */
.card-body .user-avatar {
  width: 50px;
  height: 50px;
}

.user-info {
  display: flex;
  align-items: center;
}

.role-badge {
  padding: 0.5rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-admin {
  background-color: #dc3545;
  color: white;
}

.badge-user {
  background-color: #0dcaf0;
  color: white;
}

.btn-group .btn {
  border-radius: 0.5rem !important;
  margin: 0 1px;
}

.user-item {
  animation: fadeInUp 0.6s ease;
}

.user-item:nth-child(2) { animation-delay: 0.1s; }
.user-item:nth-child(3) { animation-delay: 0.2s; }
.user-item:nth-child(4) { animation-delay: 0.3s; }

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  animation: fadeInUp 0.6s ease;
}

.form-control:focus,
.form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-outline-primary:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
}

/* 按钮交互效果 */
.btn-light {
  transition: all 0.3s ease;
}

.btn-light:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.btn-light:active {
  transform: translateY(0);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  .col-md-4.text-end {
    text-align: center !important;
    margin-top: 1rem;
  }
  
  .d-flex.gap-2 {
    justify-content: center !important;
  }
  
  .user-card .btn-group {
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .user-card .btn-group .btn {
    margin: 0;
    border-radius: 0.375rem !important;
  }
  
  .table-responsive {
    font-size: 0.875rem;
  }
}

@media (max-width: 360px) {
  /* 在最小屏幕上减少按钮之间的间距 */
  .d-flex.gap-2 {
    gap: 0.25rem !important;
  }
  
  .btn-lg {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
  }
}
</style>

  <!-- 筛选和搜索栏 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-lg-3 col-md-6">
              <label for="roleFilter" class="form-label fw-semibold">
                <i class="fas fa-filter me-2 text-primary"></i>角色筛选
              </label>
              <select class="form-select" id="roleFilter">
                <option value="">全部角色</option>
                <option value="admin">管理员</option>
                <option value="user">普通用户</option>
              </select>
            </div>
            <div class="col-lg-6 col-md-8">
              <label for="userSearch" class="form-label fw-semibold">
                <i class="fas fa-search me-2 text-primary"></i>快速搜索
              </label>
              <input type="text" class="form-control" id="userSearch" placeholder="搜索用户名、ID...">
            </div>
            <div class="col-lg-3 col-md-4">
              <div class="d-flex gap-2">
                <div class="d-grid flex-grow-1">
                  <button type="button" class="btn btn-outline-primary" id="resetFilters">
                    <i class="fas fa-undo me-2"></i>重置
                  </button>
                </div>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-primary btn-sm active" id="tableViewBtn">
                    <i class="fas fa-list me-1"></i>列表
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="cardViewBtn">
                    <i class="fas fa-th-large me-1"></i>卡片
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- 用户列表 -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow">
          <div class="card-header bg-white border-bottom">
            <div class="row align-items-center">
              <div class="col">
                <h5 class="mb-0">
                  <i class="fas fa-list me-2 text-primary"></i>用户列表
                </h5>
              </div>
            </div>
          </div>
          
          <!-- 表格视图 -->
          <div id="tableView" class="card-body p-0">
            {% if users %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-header-modern">
                  <tr>
                    <th class="border-0 fw-bold header-cell">
                      <div class="header-content">
                        <div class="header-icon user-icon">
                          <i class="fas fa-user"></i>
                        </div>
                        <span class="header-text">用户信息</span>
                      </div>
                    </th>
                    <th class="border-0 fw-bold header-cell">
                      <div class="header-content">
                        <div class="header-icon role-icon">
                          <i class="fas fa-shield-alt"></i>
                        </div>
                        <span class="header-text">角色权限</span>
                      </div>
                    </th>
                    <th class="border-0 fw-bold header-cell text-center">
                      <div class="header-content justify-content-center">
                        <div class="header-icon action-icon">
                          <i class="fas fa-cogs"></i>
                        </div>
                        <span class="header-text">操作</span>
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  {% for user in users %}
                  <tr class="user-row" data-user-id="{{ user.id }}" data-role="{{ 'admin' if user.is_admin else 'user' }}" data-username="{{ user.username|lower }}">
                    <td class="align-middle">
                      <div class="d-flex align-items-center">
                        <div class="user-avatar me-3">
                          <img src="{% if user.Avatar %}{{ user.Avatar }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}&background=random&size=40{% endif %}" 
                               alt="用户头像" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                        </div>
                        <div>
                          <div class="user-name">{{ user.username }}</div>
                          <small class="user-id">ID: {{ user.id }}</small>
                        </div>
                      </div>
                    </td>
                    <td class="align-middle">
                      {% if user.is_admin %}
                      <span class="role-badge badge bg-danger">
                        <i class="fas fa-shield-alt me-1"></i>管理员
                      </span>
                      {% else %}
                      <span class="role-badge badge bg-info">
                        <i class="fas fa-user me-1"></i>普通用户
                      </span>
                      {% endif %}
                    </td>
                    <td class="align-middle text-center">
                      <div class="btn-group" role="group">
                        <a href="{{ url_for('admin_edit_user', id=user.id) }}" 
                           class="btn btn-outline-primary btn-sm"
                           data-bs-toggle="tooltip" title="编辑用户">
                          <i class="fas fa-edit"></i>
                        </a>
                        {% if user.id != current_user.id %}
                        <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="confirmDelete('{{ user.username }}', '{{ url_for('admin_delete_user', id=user.id) }}')"
                                data-bs-toggle="tooltip" title="删除用户">
                          <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state text-center py-5">
              <i class="fas fa-users fa-4x text-muted mb-4"></i>
              <h5 class="text-muted mb-3">暂无用户记录</h5>
              <p class="text-muted mb-4">还没有任何用户，点击添加用户开始管理</p>
              <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-user-plus me-2"></i>添加用户
              </a>
            </div>
            {% endif %}
          </div>

    <!-- 卡片视图 -->
          <div id="cardView" class="card-body p-4" style="display: none;">
            {% if users %}
            <div class="row g-4" id="userCardsGrid">
              {% for user in users %}
              <div class="col-lg-4 col-md-6 user-item" 
                   data-user-id="{{ user.id }}" 
                   data-role="{{ 'admin' if user.is_admin else 'user' }}" 
                   data-username="{{ user.username|lower }}">
                <div class="user-card card border-0 shadow-sm h-100">
                  <div class="card-header bg-light border-bottom-0">
                    <div class="row align-items-center">
                      <div class="col">
                        <h6 class="mb-0 fw-bold">{{ user.username }}</h6>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="user-info mb-3 d-flex align-items-center">
                      <div class="user-avatar me-3">
                        <img src="{% if user.Avatar %}{{ user.Avatar }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}&background=random&size=50{% endif %}" 
                             alt="用户头像" class="rounded-circle" width="50" height="50" style="object-fit: cover;">
                      </div>
                      <div>
                        <div class="small text-muted">用户ID</div>
                        <div class="fw-semibold">{{ user.id }}</div>
                      </div>
                    </div>
                    <div class="info-item mb-2">
                      <i class="fas fa-user-shield text-primary me-2"></i>
                      <span>角色: 
                        {% if user.is_admin %}
                        <span class="badge bg-danger">管理员</span>
                        {% else %}
                        <span class="badge bg-info">普通用户</span>
                        {% endif %}
                      </span>
                    </div>
                  </div>
                  <div class="card-footer bg-white border-top">
                    <div class="btn-group w-100" role="group">
                      <a href="{{ url_for('admin_edit_user', id=user.id) }}" 
                         class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i>编辑
                      </a>
                      {% if user.id != current_user.id %}
                      <button type="button" class="btn btn-outline-danger btn-sm"
                              onclick="confirmDelete('{{ user.username }}', '{{ url_for('admin_delete_user', id=user.id) }}')">
                        <i class="fas fa-trash me-1"></i>删除
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="empty-state text-center py-5">
              <i class="fas fa-users fa-4x text-muted mb-4"></i>
              <h5 class="text-muted mb-3">暂无用户记录</h5>
              <p class="text-muted mb-4">还没有任何用户，点击添加用户开始管理</p>
              <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-user-plus me-2"></i>添加用户
              </a>
            </div>
            {% endif %}
          </div>
          
          <!-- 空状态 -->
          <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-search fa-4x text-muted mb-4"></i>
            <h5 class="text-muted mb-3">没有找到用户</h5>
            <p class="text-muted mb-4">尝试调整搜索条件或清除筛选</p>
            <button id="clearFiltersBtn" class="btn btn-primary">
              <i class="fas fa-undo me-2"></i>清除筛选
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 初始化工具提示
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  const searchInput = document.getElementById('userSearch');
  const roleFilter = document.getElementById('roleFilter');
  const tableViewBtn = document.getElementById('tableViewBtn');
  const cardViewBtn = document.getElementById('cardViewBtn');
  const tableView = document.getElementById('tableView');
  const cardView = document.getElementById('cardView');
  const emptyState = document.getElementById('emptyState');
  const resetFiltersBtn = document.getElementById('resetFilters');
  const clearFiltersBtn = document.getElementById('clearFiltersBtn');

  // 视图切换
  function switchView(viewType) {
    if (viewType === 'table') {
      tableView.style.display = 'block';
      cardView.style.display = 'none';
      tableViewBtn.classList.add('active');
      cardViewBtn.classList.remove('active');
    } else {
      tableView.style.display = 'none';
      cardView.style.display = 'block';
      tableViewBtn.classList.remove('active');
      cardViewBtn.classList.add('active');
    }
    localStorage.setItem('userViewMode', viewType);
  }

  // 加载保存的视图模式
  const savedViewMode = localStorage.getItem('userViewMode') || 'table';
  switchView(savedViewMode);

  tableViewBtn.addEventListener('click', () => switchView('table'));
  cardViewBtn.addEventListener('click', () => switchView('card'));

  // 搜索和过滤功能
  function filterUsers() {
    const searchTerm = searchInput.value.toLowerCase();
    const roleValue = roleFilter.value;
    const tableRows = document.querySelectorAll('.user-row');
    const userItems = document.querySelectorAll('.user-item');
    let visibleCount = 0;

    // 过滤表格行
    tableRows.forEach(row => {
      const username = row.dataset.username;
      const role = row.dataset.role;
      const userId = row.dataset.userId;
      const matchesSearch = username.includes(searchTerm) || userId.includes(searchTerm);
      const matchesRole = !roleValue || role === roleValue;
      
      if (matchesSearch && matchesRole) {
        row.classList.remove('d-none');
        visibleCount++;
      } else {
        row.classList.add('d-none');
      }
    });

    // 过滤卡片
    userItems.forEach(item => {
      const username = item.dataset.username;
      const role = item.dataset.role;
      const userId = item.dataset.userId;
      const matchesSearch = username.includes(searchTerm) || userId.includes(searchTerm);
      const matchesRole = !roleValue || role === roleValue;
      
      if (matchesSearch && matchesRole) {
        item.classList.remove('d-none');
      } else {
        item.classList.add('d-none');
      }
    });

    // 显示/隐藏空状态
    if (visibleCount === 0) {
      emptyState.style.display = 'block';
      tableView.style.display = 'none';
      cardView.style.display = 'none';
    } else {
      emptyState.style.display = 'none';
      const currentView = localStorage.getItem('userViewMode') || 'table';
      switchView(currentView);
    }
  }

  // 防抖函数
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // 添加防抖处理的搜索
  searchInput.addEventListener('input', debounce(filterUsers, 300));
  roleFilter.addEventListener('change', filterUsers);

  // 重置筛选
  function resetFilters() {
    searchInput.value = '';
    roleFilter.value = '';
    
    document.querySelectorAll('.user-row, .user-item').forEach(item => {
      item.classList.remove('d-none');
    });
    
    emptyState.style.display = 'none';
    const currentView = localStorage.getItem('userViewMode') || 'table';
    switchView(currentView);
  }
  
  resetFiltersBtn.addEventListener('click', resetFilters);
  clearFiltersBtn?.addEventListener('click', resetFilters);

  // 确认删除
  let deleteUserUrl = '';
  
  window.confirmDelete = function(username, url) {
    deleteUserUrl = url;
    document.getElementById('deleteUsername').textContent = username;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    return false;
  }
  
  // 确认删除按钮事件
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteUserUrl) {
      // 创建表单并提交POST请求
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = deleteUserUrl;
      document.body.appendChild(form);
      form.submit();
    }
  });

  // 添加键盘快捷键
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F 聚焦搜索框
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      searchInput.focus();
    }
    
    // Ctrl/Cmd + R 重置筛选
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
      e.preventDefault();
      resetFilters();
    }
    
    // Ctrl/Cmd + T 切换表格视图
    if ((e.ctrlKey || e.metaKey) && e.key === 't') {
      e.preventDefault();
      tableViewBtn.click();
    }
    
    // Ctrl/Cmd + C 切换卡片视图
    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
      e.preventDefault();
      cardViewBtn.click();
    }
  });
});
</script>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>确认删除用户
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
          <h6 class="mb-3">您确定要删除以下用户吗？</h6>
          <div class="alert alert-warning">
            <strong id="deleteUsername"></strong>
          </div>
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            此操作将永久删除该用户账户，且无法恢复。
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>取消
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash me-2"></i>确认删除
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
