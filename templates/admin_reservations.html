{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
<style>
  /* 统计卡片样式 */
  .stat-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    text-align: center;
    border: 1px solid #e9ecef;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  
  .stat-card .icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .stat-card h4 {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
  }
  
  .stat-card p {
    color: #6c757d;
    font-weight: 500;
    margin: 0;
  }

  /* 表格标题文字白色样式 */
  .table-header-modern .header-text {
    color: white !important;
  }

  /* 头像样式 */
  .avatar-sm {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
  }

  /* 卡片视图样式 */
  #cardView {
    padding: 20px;
  }

  .reservation-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
    padding: 1.5rem;
    border: 3px solid #343a40;
    border-radius: 15px;
    background-color: #f8f9fa;
  }

  .reservation-card {
    background: white;
    border: 2px solid #343a40;
    border-radius: 15px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
  }

  .reservation-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea, #764ba2);
  }

  .reservation-header-info {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }

  .reservation-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
  }

  .reservation-room {
    color: #667eea;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .badge-pending {
    background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
    color: #8b4513;
  }

  .badge-confirmed {
    background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
    color: #065f46;
  }

  .badge-cancelled {
    background: linear-gradient(135deg, #fecaca, #f87171);
    color: #7f1d1d;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
  }

  .user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    text-transform: uppercase;
  }

  .user-details h5 {
    margin: 0;
    font-weight: 600;
    color: #2c3e50;
  }

  .user-details p {
    margin: 0;
    color: #6c757d;
    font-size: 0.9rem;
  }

  .reservation-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
  }

  .info-item {
    text-align: center;
  }

  .info-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 0.3rem;
  }

  .info-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #495057;
  }

  .reservation-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
  }

  .action-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .btn-confirm {
    background: linear-gradient(135deg, #00b894, #00cec9);
    color: white;
    box-shadow: 0 3px 12px rgba(0, 184, 148, 0.3);
  }

  .btn-confirm:hover {
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 184, 148, 0.4);
  }

  .btn-edit {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
  }

  .btn-edit:hover {
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  .btn-delete {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    box-shadow: 0 3px 12px rgba(255, 107, 107, 0.3);
  }

  .btn-delete:hover {
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
  }

        /* 图标颜色主题 */
        .type-icon { 
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 50%, #6c5ce7 100%);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }
        .attendees-icon { 
            background: linear-gradient(135deg, #00cec9 0%, #00b894 50%, #00cec9 100%);
            box-shadow: 0 4px 15px rgba(0, 206, 201, 0.4);
        }

  /* 视图切换按钮组样式修复 */
  .btn-group {
    display: flex;
    white-space: nowrap;
  }
  
  .btn-group .btn {
    flex: 1;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem !important;
    margin: 0 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .btn-group .btn i {
    font-size: 0.8rem;
  }

  /* 表单控件统一样式 */
  .form-control, .form-select {
    height: 42px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    transform: translateY(-1px);
  }

  .form-label {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .input-group .form-control {
    border-left: none;
  }

  .input-group-text {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-right: none;
    color: #6c757d;
  }

  /* 筛选和操作按钮区域样式 */
  .btn-outline-secondary, .btn-outline-info {
    border-radius: 8px;
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-outline-secondary:hover {
    background: #6c757d;
    border-color: #6c757d;
    transform: translateY(-1px);
  }

  .btn-outline-info:hover {
    background: #0dcaf0;
    border-color: #0dcaf0;
    transform: translateY(-1px);
  }

  /* 搜索和筛选控件样式改进 */
  .input-group-text {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 2px solid #e9ecef;
    border-right: none;
    color: #6c757d;
    border-radius: 0.75rem 0 0 0.75rem;
  }

  .input-group .form-control {
    border-left: none;
    border-radius: 0 0.75rem 0.75rem 0;
  }

  /* 空状态样式增强 */
  .empty-state-content {
    background: white;
    border-radius: 1rem;
    padding: 3rem 2rem;
    margin: 2rem auto;
    max-width: 500px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
  }

  .empty-state-content i {
    opacity: 0.6;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* 筛选统计样式 */
  .alert.alert-info {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 1rem;
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .alert.alert-info .btn-outline-light {
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
    background: rgba(255, 255, 255, 0.1);
  }

  .alert.alert-info .btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-1px);
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .reservation-cards-grid {
      grid-template-columns: 1fr;
      padding: 1rem;
    }
    
    .reservation-info-grid {
      grid-template-columns: 1fr;
    }
    
    .reservation-actions {
      flex-direction: column;
    }
    
    /* 移动端筛选控件优化 */
    .row.align-items-end {
      align-items: stretch !important;
    }
    
    .form-control, .form-select {
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
      height: 38px;
    }

    .form-label {
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
    }

    /* 移动端按钮区域优化 */
    .col-lg-6.col-md-8 .d-flex,
    .col-lg-6.col-md-4 .d-flex {
      flex-direction: column;
      gap: 0.5rem !important;
    }

    .btn-group {
      width: 100%;
    }

    .btn-group .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
    }

    .btn-group .btn span {
      display: inline !important;
    }
  }  /* 小屏幕优化 */
  @media (max-width: 576px) {
    .row.align-items-end .col-lg-4,
    .row.align-items-end .col-lg-2 {
      margin-bottom: 1rem;
    }

    .btn-group .btn {
      font-size: 0.75rem;
      padding: 0.375rem 0.5rem;
    }

    .btn-group .btn span {
      display: none !important;
    }

    .d-flex.gap-3 {
      gap: 0.5rem !important;
      flex-direction: column;
    }

    .btn-outline-secondary, .btn-outline-info {
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .col-lg-6.col-md-8 .d-flex,
    .col-lg-6.col-md-4 .d-flex {
      justify-content: center;
    }
  }

  /* 黑色主题样式 */
  .reservation-list-black,
  .reservation-list-black * {
    color: black !important;
  }

  .reservation-list-black .text-primary,
  .reservation-list-black .text-info,
  .reservation-list-black .text-success,
  .reservation-list-black .text-warning,
  .reservation-list-black .text-danger {
    color: black !important;
  }

  /* 分页样式 */
  .pagination {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .pagination .page-item .page-link {
    border: none;
    color: #495057;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    transition: all 0.3s ease;
  }

  .pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
  }

  .pagination .page-item:hover .page-link {
    background-color: #f8f9fa;
    color: #495057;
    transform: translateY(-1px);
  }

  .pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #f8f9fa;
  }

  .form-select-sm {
    border-radius: 6px;
    border: 1px solid #ced4da;
    transition: all 0.3s ease;
  }

  .form-select-sm:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }

  .reservation-list-black i {
    color: black !important;
  }

  .reservation-list-black .badge {
    color: white !important; /* 保持徽章文字为白色以确保可读性 */
  }

  /* 表格黑色主题 */
  #reservationTableBody td {
    color: black !important;
  }

  #reservationTableBody td i {
    color: black !important;
  }

  #reservationTableBody td strong {
    color: black !important;
  }

  /* 卡片黑色主题 */
  .reservation-card {
    color: black !important;
  }

  .reservation-card .reservation-title {
    color: black !important;
  }

  .reservation-card .reservation-room {
    color: black !important;
  }

  .reservation-card i {
    color: black !important;
  }

  /* 表单控件统一样式 */
  
  /* 预约列表表格圆角样式 */
  .card .table-responsive {
    border-bottom-left-radius: 1rem !important;
    border-bottom-right-radius: 1rem !important;
    overflow: hidden !important;
  }
  
  .card .table {
    border-bottom-left-radius: 1rem !important;
    border-bottom-right-radius: 1rem !important;
    margin-bottom: 0 !important;
  }
  
  .card .table tbody tr:last-child td {
    border-bottom: none !important;
  }
  
  .card .table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 1rem !important;
  }
  
  .card .table tbody tr:last-child td:last-child {
    border-bottom-right-radius: 1rem !important;
  }
  
  /* 确保卡片整体圆角 */
  .card {
    border-radius: 1rem !important;
    overflow: hidden !important;
  }
  
  .card .card-body {
    border-bottom-left-radius: 1rem !important;
    border-bottom-right-radius: 1rem !important;
  }
</style>

  <!-- 页面标题和操作栏 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient border-0">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="mb-2 text-white">
                <i class="fas fa-calendar-check me-3"></i>预约管理
              </h2>
              <p class="mb-0 text-white-50">管理所有会议室预约和安排</p>
            </div>
            <div class="col-md-4 text-end">
              <div class="d-flex gap-2 justify-content-end flex-wrap">
                <a href="{{ url_for('new_reservation') }}" class="btn btn-light btn-lg">
                  <i class="fas fa-plus me-2"></i>新建预约
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-lg">
                  <i class="fas fa-arrow-left me-2"></i>返回控制面板
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 统计卡片 -->
  <div class="row mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="icon">
          <i class="fas fa-calendar-check fa-3x"></i>
        </div>
        <h4>{{ reservations|length }}</h4>
        <p>总预约数</p>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="icon">
          <i class="fas fa-building fa-3x"></i>
        </div>
        <h4>{{ reservations|selectattr('room.RoomType', 'equalto', 'Offline')|list|length }}</h4>
        <p>线下会议</p>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="icon">
          <i class="fas fa-laptop fa-3x"></i>
        </div>
        <h4>{{ reservations|selectattr('room.RoomType', 'equalto', 'Online')|list|length }}</h4>
        <p>线上会议</p>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="icon">
          <i class="fas fa-hourglass-half fa-3x"></i>
        </div>
        <h4>{{ reservations|selectattr('Status', 'equalto', 'Pending')|list|length }}</h4>
        <p>待确认</p>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="icon">
          <i class="fas fa-check-circle fa-3x"></i>
        </div>
        <h4>{{ reservations|selectattr('Status', 'equalto', 'Confirmed')|list|length }}</h4>
        <p>已确认</p>
      </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
      <div class="stat-card">
        <div class="icon">
          <i class="fas fa-calendar-day fa-3x"></i>
        </div>
        <h4>{{ reservations|today|length }}</h4>
        <p>今日预约</p>
      </div>
    </div>
  </div>

  <!-- 搜索和过滤控件 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row align-items-end g-3">
            <div class="col-lg-4 col-md-6">
              <label for="reservationSearch" class="form-label text-muted fw-semibold">
                <i class="fas fa-search me-1"></i>搜索关键词
              </label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-search"></i>
                </span>
                <input type="text" 
                       class="form-control" 
                       id="reservationSearch" 
                       placeholder="搜索预约标题、会议室或用户...">
              </div>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6">
              <label for="statusFilter" class="form-label text-muted fw-semibold">
                <i class="fas fa-info-circle me-1"></i>状态筛选
              </label>
              <select class="form-select" id="statusFilter">
                <option value="">所有状态</option>
                <option value="Pending">待确认</option>
                <option value="Confirmed">已确认</option>
                <option value="Cancelled">已取消</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6">
              <label for="meetingTypeFilter" class="form-label text-muted fw-semibold">
                <i class="fas fa-cogs me-1"></i>会议类型
              </label>
              <select class="form-select" id="meetingTypeFilter">
                <option value="">所有类型</option>
                <option value="Offline">线下会议</option>
                <option value="Online">线上会议</option>
              </select>
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6">
              <label for="startDate" class="form-label text-muted fw-semibold">
                <i class="fas fa-calendar me-1"></i>开始日期
              </label>
              <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6">
              <label for="endDate" class="form-label text-muted fw-semibold">
                <i class="fas fa-calendar me-1"></i>结束日期
              </label>
              <input type="date" class="form-control" id="endDate">
            </div>
          </div>
          
          <!-- 视图切换和操作按钮行 -->
          <div class="row mt-3 align-items-center">
            <div class="col-lg-6 col-md-8">
              <div class="d-flex align-items-center gap-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()" style="color: black; border-color: black;">
                  <i class="fas fa-times me-1"></i>清除筛选
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="exportReservations()" style="color: black; border-color: black;">
                  <i class="fas fa-download me-1"></i>导出数据
                </button>
              </div>
            </div>
            <div class="col-lg-6 col-md-4">
              <div class="d-flex justify-content-end align-items-center">
                <label class="form-label text-muted fw-semibold me-2 mb-0">
                  <i class="fas fa-eye me-1"></i>视图模式
                </label>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-primary active" id="tableViewBtn">
                    <i class="fas fa-table me-1"></i><span class="d-none d-lg-inline">列表</span>
                  </button>
                  <button type="button" class="btn btn-outline-primary" id="cardViewBtn">
                    <i class="fas fa-th-large me-1"></i><span class="d-none d-lg-inline">卡片</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 筛选结果统计 -->
          <div class="row mt-3" id="filterStats" style="display: none;">
            <div class="col-12">
              <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <span id="filterStatsText">显示结果统计</span>
                <button class="btn btn-sm btn-outline-light ms-auto" onclick="clearAllFilters()">
                  <i class="fas fa-times me-1"></i>清除筛选
                </button>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 表格视图 -->
  <div id="tableView" class="view-content">
    <div class="card">
      <!-- 表格操作栏 -->
      <div class="card-header bg-white border-bottom">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="mb-0" style="color: black;">
              <i class="fas fa-table me-2"></i>预约列表
            </h5>
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-outline-primary btn-sm" onclick="exportReservations()" style="color: black; border-color: black;">
              <i class="fas fa-download me-1"></i>导出数据
            </button>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 reservation-list-black">
            <thead class="table-header-modern">
              <tr>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon title-icon">
                      <i class="fas fa-heading"></i>
                    </div>
                    <span class="header-text">预约标题</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon room-icon">
                      <i class="fas fa-door-open"></i>
                    </div>
                    <span class="header-text">会议室</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon type-icon">
                      <i class="fas fa-cogs"></i>
                    </div>
                    <span class="header-text">类型</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon attendees-icon">
                      <i class="fas fa-users"></i>
                    </div>
                    <span class="header-text">参会人数</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon user-icon">
                      <i class="fas fa-user"></i>
                    </div>
                    <span class="header-text">预约人</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon start-icon">
                      <i class="fas fa-play"></i>
                    </div>
                    <span class="header-text">开始时间</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon end-icon">
                      <i class="fas fa-stop"></i>
                    </div>
                    <span class="header-text">结束时间</span>
                  </div>
                </th>
                <th class="header-cell">
                  <div class="header-content">
                    <div class="header-icon status-icon">
                      <i class="fas fa-info-circle"></i>
                    </div>
                    <span class="header-text">状态</span>
                  </div>
                </th>
                <th class="header-cell text-center">
                  <div class="header-content justify-content-center">
                    <div class="header-icon action-icon">
                      <i class="fas fa-tools"></i>
                    </div>
                    <span class="header-text">操作</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="reservationTableBody">
              {% if reservations %}
              {% for reservation in reservations %}
              <tr data-reservation-id="{{ reservation.ID }}" 
                  data-status="{{ reservation.Status }}"
                  data-title="{{ reservation.Title|lower }}"
                  data-room="{{ reservation.room.RoomName|lower }}"
                  data-user="{{ reservation.user.UserName }}"
                  data-user-original="{{ reservation.user.UserName }}"
                  data-type="{{ reservation.room.RoomType }}"
                  data-attendees="{{ reservation.attendees }}"
                  data-date="{{ reservation.StartTime.strftime('%Y-%m-%d') }}">
                <td>
                  <strong style="color: black;">{{ reservation.Title }}</strong>
                </td>
                <td>
                  <i class="fas fa-door-open me-2" style="color: black;"></i>
                  <span style="color: black;">{{ reservation.room.RoomName }}</span>
                </td>
                <td>
                  {% if reservation.room.RoomType == 'Online' %}
                  <span class="badge bg-info">
                    <i class="fas fa-laptop me-1"></i>线上
                  </span>
                  {% else %}
                  <span class="badge bg-success">
                    <i class="fas fa-building me-1"></i>线下
                  </span>
                  {% endif %}
                </td>
                <td>
                  <i class="fas fa-users me-1" style="color: black;"></i>
                  <span style="color: black;">{{ reservation.attendees }} 人</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm me-2">
                      {{ reservation.user.UserName[0] }}
                    </div>
                    <span style="color: black;">{{ reservation.user.UserName }}</span>
                  </div>
                </td>
                <td style="color: black;">{{ reservation.StartTime.strftime('%Y-%m-%d %H:%M') }}</td>
                <td style="color: black;">{{ reservation.EndTime.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                  {% if reservation.Status == 'Pending' %}
                  <span class="badge bg-warning">
                    <i class="fas fa-hourglass-half me-1"></i>待确认
                  </span>
                  {% elif reservation.Status == 'Confirmed' %}
                  <span class="badge bg-success">
                    <i class="fas fa-check-circle me-1"></i>已确认
                  </span>
                  {% elif reservation.Status == 'Cancelled' %}
                  <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>已取消
                  </span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group" role="group">
                    {% if reservation.Status == 'Pending' %}
                    <a href="javascript:void(0)" 
                       class="btn btn-sm btn-success confirm-reservation-btn"
                       data-id="{{ reservation.ID }}"
                       data-title="{{ reservation.Title }}"
                       data-url="{{ url_for('confirm_reservation', id=reservation.ID) }}"
                       title="确认预约">
                      <i class="fas fa-check"></i>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('edit_reservation', id=reservation.ID) }}" 
                       class="btn btn-sm btn-primary"
                       title="编辑预约">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a href="javascript:void(0)" 
                       class="btn btn-sm btn-danger delete-reservation-btn"
                       data-title="{{ reservation.Title }}"
                       data-url="{{ url_for('delete_reservation', id=reservation.ID) }}"
                       title="删除预约">
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="8" class="text-center py-5">
                  <div class="empty-state-content">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无预约记录</h5>
                    <p class="text-muted">还没有任何预约记录，等待用户创建预约。</p>
                  </div>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 卡片视图 -->
  <div id="cardView" class="view-content" style="display: none;">
    <!-- 卡片视图操作栏 -->
    <div class="card mb-3">
      <div class="card-header bg-white border-bottom">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="mb-0" style="color: black;">
              <i class="fas fa-th-large me-2"></i>预约卡片
            </h5>
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-outline-primary btn-sm" onclick="exportReservations()" style="color: black; border-color: black;">
              <i class="fas fa-download me-1"></i>导出数据
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="reservation-cards-grid reservation-list-black" id="reservationCardsGrid">
      {% if reservations %}
      {% for reservation in reservations %}
      <div class="reservation-card" 
           data-reservation-id="{{ reservation.ID }}" 
           data-status="{{ reservation.Status }}"
           data-title="{{ reservation.Title|lower }}"
           data-room="{{ reservation.room.RoomName|lower }}"
           data-user="{{ reservation.user.UserName|lower }}"
           data-user-original="{{ reservation.user.UserName }}"
           data-type="{{ reservation.room.RoomType }}"
           data-attendees="{{ reservation.attendees }}"
           data-date="{{ reservation.StartTime.strftime('%Y-%m-%d') }}">
        
        <div class="reservation-header-info">
          <div>
            <h3 class="reservation-title" style="color: black;">{{ reservation.Title }}</h3>
            <div class="reservation-room" style="color: black;">
              <i class="fas fa-door-open me-1" style="color: black;"></i>
              {{ reservation.room.RoomName }}
            </div>
            <div class="reservation-type-attendees mt-2">
              {% if reservation.room.RoomType == 'Online' %}
              <span class="badge bg-info me-2">
                <i class="fas fa-laptop me-1"></i>线上
              </span>
              {% else %}
              <span class="badge bg-success me-2">
                <i class="fas fa-building me-1"></i>线下
              </span>
              {% endif %}
              <span class="badge bg-secondary">
                <i class="fas fa-users me-1"></i>{{ reservation.attendees }} 人
              </span>
            </div>
          </div>
          {% if reservation.Status == 'Pending' %}
          <span class="status-badge badge-pending">
            <i class="fas fa-hourglass-half"></i>待确认
          </span>
          {% elif reservation.Status == 'Confirmed' %}
          <span class="status-badge badge-confirmed">
            <i class="fas fa-check-circle"></i>已确认
          </span>
          {% elif reservation.Status == 'Cancelled' %}
          <span class="status-badge badge-cancelled">
            <i class="fas fa-times-circle"></i>已取消
          </span>
          {% endif %}
        </div>
        
        <div class="user-info">
          <div class="user-avatar">
            {{ reservation.user.UserName[0] }}
          </div>
          <div class="user-details">
            <h5 style="color: black;">{{ reservation.user.UserName }}</h5>
            <p style="color: black;">预约人</p>
          </div>
        </div>
        
        <div class="reservation-info-grid">
          <div class="info-item">
            <div class="info-label" style="color: black;">开始时间</div>
            <div class="info-value" style="color: black;">{{ reservation.StartTime.strftime('%m-%d %H:%M') }}</div>
          </div>
          <div class="info-item">
            <div class="info-label" style="color: black;">结束时间</div>
            <div class="info-value" style="color: black;">{{ reservation.EndTime.strftime('%Y-%m-%d %H:%M') }}</div>
          </div>
        </div>
        
        <div class="reservation-actions">
          {% if reservation.Status == 'Pending' %}
          <a href="javascript:void(0)" 
             class="action-btn btn-confirm confirm-reservation-btn"
             data-id="{{ reservation.ID }}"
             data-title="{{ reservation.Title }}"
             data-url="{{ url_for('confirm_reservation', id=reservation.ID) }}">
            <i class="fas fa-check"></i>确认
          </a>
          {% endif %}
          <a href="{{ url_for('edit_reservation', id=reservation.ID) }}" 
             class="action-btn btn-edit">
            <i class="fas fa-edit"></i>编辑
          </a>
          <a href="javascript:void(0)" 
             class="action-btn btn-delete delete-reservation-btn"
             data-title="{{ reservation.Title }}"
             data-url="{{ url_for('delete_reservation', id=reservation.ID) }}">
            <i class="fas fa-trash"></i>删除
          </a>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="text-center py-5 col-12">
        <div class="empty-state-content">
          <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
          <h4 class="text-muted">暂无预约记录</h4>
          <p class="text-muted">还没有任何预约记录，等待用户创建预约。</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- 共享分页控件 -->
  <div class="mt-4">
    <!-- 分页信息和每页显示控件 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <span class="text-muted">
          显示第 {{ (pagination.page - 1) * pagination.per_page + 1 }} - 
          {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 条，
          共 {{ pagination.total }} 条记录
        </span>
      </div>
      
      <!-- 每页显示条数选择 -->
      <div class="d-flex align-items-center">
        <span class="text-muted me-2">每页显示：</span>
        <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
          <option value="10" {% if request.args.get('per_page', 10, type=int) == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if request.args.get('per_page', 10, type=int) == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if request.args.get('per_page', 10, type=int) == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if request.args.get('per_page', 10, type=int) == 100 %}selected{% endif %}>100</option>
        </select>
      </div>
    </div>
    
    <!-- 分页导航 -->
    {% if pagination.pages > 1 %}
    <div class="d-flex justify-content-center">
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <!-- 首页 -->
          {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_reservations', page=1, per_page=request.args.get('per_page', 10, type=int)) }}">
              <i class="fas fa-angle-double-left"></i>
            </a>
          </li>
          <!-- 上一页 -->
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_reservations', page=pagination.prev_num, per_page=request.args.get('per_page', 10, type=int)) }}">
              <i class="fas fa-angle-left"></i>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
          </li>
          <li class="page-item disabled">
            <span class="page-link"><i class="fas fa-angle-left"></i></span>
          </li>
          {% endif %}
          
          <!-- 页码 -->
          {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
              {% if page_num != pagination.page %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('admin_reservations', page=page_num, per_page=request.args.get('per_page', 10, type=int)) }}">{{ page_num }}</a>
              </li>
              {% else %}
              <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
              </li>
              {% endif %}
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">…</span>
            </li>
            {% endif %}
          {% endfor %}
          
          <!-- 下一页 -->
          {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_reservations', page=pagination.next_num, per_page=request.args.get('per_page', 10, type=int)) }}">
              <i class="fas fa-angle-right"></i>
            </a>
          </li>
          <!-- 末页 -->
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_reservations', page=pagination.pages, per_page=request.args.get('per_page', 10, type=int)) }}">
              <i class="fas fa-angle-double-right"></i>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <span class="page-link"><i class="fas fa-angle-right"></i></span>
          </li>
          <li class="page-item disabled">
            <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>

  <!-- 空状态 -->
  <div id="emptyState" class="text-center py-5" style="display: none;">
    <div class="empty-state-content">
      <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
      <h4 class="text-muted">没有找到预约记录</h4>
      <p class="text-muted mb-4">尝试调整筛选条件或创建新的预约</p>
      <div class="d-flex gap-2 justify-content-center">
        <button class="btn btn-outline-primary" onclick="clearAllFilters()">
          <i class="fas fa-filter me-1"></i>清除筛选
        </button>
        <a href="{{ url_for('new_reservation') }}" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i>新建预约
        </a>
      </div>
    </div>
  </div>
</div>

<script>
// 更改每页显示条数
function changePerPage(perPage) {
  const urlParams = new URLSearchParams(window.location.search);
  urlParams.set('per_page', perPage);
  urlParams.set('page', 1); // 重置到第一页
  window.location.href = window.location.pathname + '?' + urlParams.toString();
}

document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('reservationSearch');
  const statusFilter = document.getElementById('statusFilter');
  const meetingTypeFilter = document.getElementById('meetingTypeFilter');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const tableViewBtn = document.getElementById('tableViewBtn');
  const cardViewBtn = document.getElementById('cardViewBtn');
  const tableView = document.getElementById('tableView');
  const cardView = document.getElementById('cardView');
  const emptyState = document.getElementById('emptyState');

  // 视图切换
  function switchView(viewType) {
    if (viewType === 'table') {
      tableView.style.display = 'block';
      cardView.style.display = 'none';
      tableViewBtn.classList.add('active');
      cardViewBtn.classList.remove('active');
    } else {
      tableView.style.display = 'none';
      cardView.style.display = 'block';
      tableViewBtn.classList.remove('active');
      cardViewBtn.classList.add('active');
    }
    // 重新触发过滤以正确显示空状态
    filterReservations();
  }

  tableViewBtn.addEventListener('click', () => switchView('table'));
  cardViewBtn.addEventListener('click', () => switchView('card'));

  // 过滤功能
  function filterReservations() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusFilterValue = statusFilter.value;
    const meetingTypeFilterValue = meetingTypeFilter.value;
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    
    const isTableView = tableView.style.display !== 'none';
    const items = isTableView 
      ? document.querySelectorAll('#reservationTableBody tr')
      : document.querySelectorAll('.reservation-card');
    
    let visibleCount = 0;
    let totalItems = items.length;
    let stats = {
      total: totalItems,
      visible: 0,
      pending: 0,
      confirmed: 0,
      cancelled: 0,
      online: 0,
      offline: 0
    };

    items.forEach(item => {
      const title = item.dataset.title;
      const room = item.dataset.room;
      const user = item.dataset.user;
      const status = item.dataset.status;
      const type = item.dataset.type;
      const date = item.dataset.date;
      
      // 检查搜索匹配
      const matchesSearch = title.includes(searchTerm) || 
                           room.includes(searchTerm) || 
                           user.includes(searchTerm);
      
      // 检查状态匹配
      const matchesStatus = !statusFilterValue || status === statusFilterValue;
      
      // 检查会议类型匹配
      const matchesMeetingType = !meetingTypeFilterValue || type === meetingTypeFilterValue;
      
      // 检查日期范围匹配
      let matchesDateRange = true;
      if (startDate && endDate) {
        matchesDateRange = date >= startDate && date <= endDate;
      } else if (startDate) {
        matchesDateRange = date >= startDate;
      } else if (endDate) {
        matchesDateRange = date <= endDate;
      }
      
      if (matchesSearch && matchesStatus && matchesMeetingType && matchesDateRange) {
        item.style.display = '';
        visibleCount++;
        stats.visible++;
        
        // 统计各状态
        if (status === 'Pending') stats.pending++;
        else if (status === 'Confirmed') stats.confirmed++;
        else if (status === 'Cancelled') stats.cancelled++;
        
        // 统计会议类型
        if (type === 'Online') stats.online++;
        else stats.offline++;
      } else {
        item.style.display = 'none';
      }
    });

    // 更新筛选统计显示
    updateFilterStats(stats, searchTerm, statusFilterValue, meetingTypeFilterValue, startDate, endDate);

    // 显示/隐藏空状态
    if (visibleCount === 0) {
      emptyState.style.display = 'block';
      if (isTableView) {
        tableView.querySelector('.table-responsive').style.display = 'none';
      } else {
        cardView.querySelector('.reservation-cards-grid').style.display = 'none';
      }
    } else {
      emptyState.style.display = 'none';
      if (isTableView) {
        tableView.querySelector('.table-responsive').style.display = 'block';
      } else {
        cardView.querySelector('.reservation-cards-grid').style.display = 'grid';
      }
    }
  }

  // 更新筛选统计
  function updateFilterStats(stats, searchTerm, statusFilter, typeFilter, startDate, endDate) {
    const filterStats = document.getElementById('filterStats');
    const filterStatsText = document.getElementById('filterStatsText');
    
    const hasFilters = searchTerm || statusFilter || typeFilter || startDate || endDate;
    
    if (hasFilters && stats.visible < stats.total) {
      filterStats.style.display = 'block';
      let statsText = `筛选显示 ${stats.visible} / ${stats.total} 条记录`;
      
      if (stats.visible > 0) {
        statsText += ` (待确认: ${stats.pending}, 已确认: ${stats.confirmed}, 已取消: ${stats.cancelled})`;
        if (typeFilter !== '') {
          statsText += ` (${typeFilter === 'Online' ? '线上' : '线下'}: ${typeFilter === 'Online' ? stats.online : stats.offline})`;
        }
      }
      
      filterStatsText.textContent = statsText;
    } else {
      filterStats.style.display = 'none';
    }
  }

  // 清除所有筛选
  window.clearAllFilters = function() {
    if (searchInput) searchInput.value = '';
    if (statusFilter) statusFilter.value = '';
    if (meetingTypeFilter) meetingTypeFilter.value = '';
    if (startDateInput) startDateInput.value = '';
    if (endDateInput) endDateInput.value = '';
    filterReservations();
  }

  // 绑定事件监听器
  if (searchInput) searchInput.addEventListener('input', filterReservations);
  if (statusFilter) statusFilter.addEventListener('change', filterReservations);
  if (meetingTypeFilter) meetingTypeFilter.addEventListener('change', filterReservations);
  if (startDateInput) startDateInput.addEventListener('change', filterReservations);
  if (endDateInput) endDateInput.addEventListener('change', filterReservations);

  // 确认删除函数
  let deleteReservationUrl = '';
  
  window.confirmDelete = function(title, url) {
    deleteReservationUrl = url;
    document.getElementById('deleteReservationTitle').textContent = title;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    return false; // 阻止默认链接行为
  }
  
  // 确认预约函数
  let confirmReservationUrl = '';
  
  window.confirmReservation = function(id, title, url) {
    confirmReservationUrl = url;
    document.getElementById('confirmReservationTitle').textContent = title;
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmReservationModal'));
    confirmModal.show();
    return false;
  }
  
  // 确认删除按钮事件
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteReservationUrl) {
      window.location.href = deleteReservationUrl;
    }
  });
  
  // 确认预约按钮事件
  document.getElementById('confirmReservationBtn').addEventListener('click', function() {
    if (confirmReservationUrl) {
      window.location.href = confirmReservationUrl;
    }
  });

  // 导出预约数据功能
  window.exportReservations = function() {
    console.log('开始导出功能...');
    
    const isTableView = document.getElementById('tableView').style.display !== 'none';
    console.log('当前视图模式:', isTableView ? '表格视图' : '卡片视图');
    
    let allItems, visibleItems;
    
    if (isTableView) {
      // 表格视图 - 获取所有表格行，然后筛选可见的
      allItems = document.querySelectorAll('#reservationTableBody tr');
      console.log('表格中总行数:', allItems.length);
      
      // 检查每一行的显示状态
      visibleItems = [];
      allItems.forEach((item, index) => {
        const isVisible = item.style.display !== 'none' && !item.classList.contains('d-none');
        console.log(`行 ${index}: display=${item.style.display}, 有d-none类=${item.classList.contains('d-none')}, 可见=${isVisible}`);
        if (isVisible) {
          visibleItems.push(item);
        }
      });
    } else {
      // 卡片视图 - 获取所有卡片，然后筛选可见的
      allItems = document.querySelectorAll('.reservation-card');
      visibleItems = Array.from(allItems).filter(item => 
        item.style.display !== 'none' && !item.classList.contains('d-none')
      );
    }
    
    console.log('总项目数:', allItems.length);
    console.log('可见项目数:', visibleItems.length);
    
    if (visibleItems.length === 0) {
      console.log('没有找到可见的项目，尝试导出所有项目...');
      // 如果没有找到可见项目，可能是因为筛选逻辑问题，尝试导出所有项目
      visibleItems = Array.from(allItems);
      console.log('使用所有项目:', visibleItems.length);
    }
    
    if (visibleItems.length === 0) {
      alert('没有可导出的数据');
      return;
    }

    let csvContent = "预约标题,会议室,类型,参会人数,预约人,开始时间,结束时间,状态\n";
    console.log('开始提取数据...');
    
    visibleItems.forEach((item, index) => {
      let title, room, type, attendees, user, startTime, endTime, status;
      
      if (isTableView) {
        // 从表格行提取数据
        const cells = item.querySelectorAll('td');
        console.log(`行 ${index} 的列数:`, cells.length);
        
        if (cells.length >= 8) {
          title = cells[0].textContent.trim();
          room = cells[1].textContent.trim();
          
          // 提取类型 - 从badge中获取
          const typeBadge = cells[2].querySelector('.badge');
          type = typeBadge ? typeBadge.textContent.trim() : '';
          
          // 提取参会人数 - 移除图标和"人"字
          const attendeesText = cells[3].textContent.trim();
          attendees = attendeesText.replace(/\s*人\s*$/, '').replace(/^\s*\s*/, '').trim();
          
          // 提取预约人 - 使用data属性获取准确的用户名
          user = item.dataset.userOriginal || item.dataset.user || cells[4].textContent.trim();
          
          startTime = cells[5].textContent.trim();
          endTime = cells[6].textContent.trim();
          
          // 提取状态 - 从badge中获取
          const statusBadge = cells[7].querySelector('.badge');
          status = statusBadge ? statusBadge.textContent.trim() : '';
          
          console.log(`行 ${index} 数据:`, {title, room, type, attendees, user, startTime, endTime, status});
        } else {
          console.log(`行 ${index} 列数不足:`, cells.length);
        }
      } else {
        // 从卡片提取数据 - 这部分保持不变
        const titleElement = item.querySelector('.reservation-title');
        title = titleElement ? titleElement.textContent.trim() : '';
        
        const roomElement = item.querySelector('.reservation-room');
        room = roomElement ? roomElement.textContent.trim().replace(/^\s*\s*/, '') : '';
        
        // 提取类型
        const typeBadge = item.querySelector('.badge.bg-info, .badge.bg-success');
        type = typeBadge ? (typeBadge.textContent.includes('线上') ? '线上' : '线下') : '';
        
        // 提取参会人数 - 从data属性或badge中获取
        const attendeesData = item.dataset.attendees;
        if (attendeesData) {
          attendees = attendeesData;
        } else {
          const attendeesBadge = item.querySelector('.badge.bg-secondary');
          attendees = attendeesBadge ? attendeesBadge.textContent.trim().replace(/\s*人\s*$/, '').replace(/^\s*\s*/, '').trim() : '';
        }
        
        // 提取预约人
        const userElement = item.querySelector('.reservation-info-grid .d-flex:first-child strong');
        user = item.dataset.userOriginal || item.dataset.user || 
          (userElement ? userElement.textContent.trim() : '');
        
        // 提取时间信息
        const timeElements = item.querySelectorAll('.reservation-info-grid .d-flex span');
        startTime = timeElements[1] ? timeElements[1].textContent.trim() : '';
        endTime = timeElements[2] ? timeElements[2].textContent.trim() : '';
        
        // 提取状态
        const statusBadge = item.querySelector('.badge.bg-warning, .badge.bg-success, .badge.bg-danger');
        if (statusBadge) {
          const statusText = statusBadge.textContent.trim();
          if (statusText.includes('待确认')) status = '待确认';
          else if (statusText.includes('已确认')) status = '已确认';
          else if (statusText.includes('已取消')) status = '已取消';
          else status = statusText;
        } else {
          status = '';
        }
      }
      
      // 清理数据中的多余空格和图标
      title = title ? title.replace(/^\s*|\s*$/g, '') : '';
      room = room ? room.replace(/\s+/g, ' ').replace(/^\s*\s*/, '').trim() : '';
      type = type ? type.replace(/\s+/g, ' ').replace(/.*\s/, '').trim() : ''; // 移除图标，只保留文字
      attendees = attendees ? attendees.replace(/\s+/g, ' ').replace(/.*\s/, '').replace('人', '').trim() : ''; // 秘除图标和"人"字
      user = user ? user.replace(/\s+/g, ' ').trim() : '';
      status = status ? status.replace(/\s+/g, ' ').replace(/.*\s/, '').trim() : ''; // 移除图标，只保留文字
      
      if (title) { // 只有当有标题时才添加到CSV
        csvContent += `"${title}","${room}","${type}","${attendees}","${user}","${startTime}","${endTime}","${status}"\n`;
      }
    });

    // 创建并下载文件
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `预约数据_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // 显示成功消息
      const viewType = isTableView ? '表格' : '卡片';
      alert(`成功导出 ${visibleItems.length} 条预约数据（${viewType}视图）`);
    }
  }

  // 简化版导出功能 - 直接导出所有可见数据
  window.exportSimple = function() {
    console.log('开始简化导出...');
    
    // 检查当前视图
    const tableView = document.getElementById('tableView');
    const isTableView = tableView && tableView.style.display !== 'none';
    
    let csvContent = "预约标题,会议室,类型,参会人数,预约人,开始时间,结束时间,状态\n";
    let rowCount = 0;
    
    if (isTableView) {
      // 表格视图导出
      const rows = document.querySelectorAll('#reservationTableBody tr');
      console.log('找到表格行数:', rows.length);
      
      rows.forEach((row, index) => {
        // 不检查可见性，直接导出所有行
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
          const title = cells[0].textContent.trim();
          const room = cells[1].textContent.trim().replace(/\s+/g, ' ');
          const typeCell = cells[2];
          const type = typeCell.querySelector('.badge') ? typeCell.querySelector('.badge').textContent.trim() : '';
          const attendeesText = cells[3].textContent.trim();
          const attendees = attendeesText.replace(/\s*人\s*$/, '').replace(/^\s*\s*/, '').trim();
          // 提取预约人 - 使用data属性获取准确的用户名
          const user = row.dataset.userOriginal || row.dataset.user || 
            (() => {
              const userCell = cells[4];
              const userDiv = userCell.querySelector('.d-flex');
              if (userDiv) {
                const textNodes = Array.from(userDiv.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
                return textNodes.length > 0 ? textNodes[textNodes.length - 1].textContent.trim() : userCell.textContent.trim();
              } else {
                return userCell.textContent.trim();
              }
            })();
          const startTime = cells[5].textContent.trim();
          const endTime = cells[6].textContent.trim();
          const statusCell = cells[7];
          const status = statusCell.querySelector('.badge') ? statusCell.querySelector('.badge').textContent.trim() : '';
          
          if (title) {
            csvContent += `"${title}","${room}","${type}","${attendees}","${user}","${startTime}","${endTime}","${status}"\n`;
            rowCount++;
          }
        }
      });
    } else {
      // 卡片视图导出
      const cards = document.querySelectorAll('.reservation-card');
      console.log('找到卡片数:', cards.length);
      
      cards.forEach(card => {
        const titleElement = card.querySelector('.reservation-title');
        const title = titleElement ? titleElement.textContent.trim() : '';
        
        if (title) {
          const roomElement = card.querySelector('.reservation-room');
          const room = roomElement ? roomElement.textContent.trim() : '';
          
          const typeBadge = card.querySelector('.badge.bg-info, .badge.bg-success');
          const type = typeBadge ? (typeBadge.textContent.includes('线上') ? '线上' : '线下') : '';
          
          // 提取参会人数 - 从data属性或badge中获取
          const attendeesData = card.dataset.attendees;
          let attendees;
          if (attendeesData) {
            attendees = attendeesData;
          } else {
            const attendeesBadge = card.querySelector('.badge.bg-secondary');
            attendees = attendeesBadge ? attendeesBadge.textContent.trim().replace(/\s*人\s*$/, '').replace(/^\s*\s*/, '').trim() : '';
          }
          
          // 使用data属性获取用户名
          const user = card.dataset.userOriginal || card.dataset.user || 
            (() => {
              const userElement = card.querySelector('.reservation-info-grid .d-flex strong');
              return userElement ? userElement.textContent.trim() : '';
            })();
          
          const timeElements = card.querySelectorAll('.reservation-info-grid .d-flex span');
          const startTime = timeElements[1] ? timeElements[1].textContent.trim() : '';
          const endTime = timeElements[2] ? timeElements[2].textContent.trim() : '';
          
          const statusBadge = card.querySelector('.badge.bg-warning, .badge.bg-success, .badge.bg-danger');
          const status = statusBadge ? statusBadge.textContent.trim() : '';
          
          csvContent += `"${title}","${room}","${type}","${attendees}","${user}","${startTime}","${endTime}","${status}"\n`;
          rowCount++;
        }
      });
    }
    
    console.log('导出行数:', rowCount);
    
    if (rowCount === 0) {
      alert('没有找到可导出的数据');
      return;
    }
    
    // 创建和下载文件
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `预约数据_简化版_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert(`成功导出 ${rowCount} 条预约数据！`);
  }

  // 验证导出数据功能
  window.validateExportData = function() {
    console.log('开始验证导出数据...');
    const isTableView = document.getElementById('tableView').style.display !== 'none';
    
    if (isTableView) {
      const rows = document.querySelectorAll('#reservationTableBody tr');
      console.log('表格行数:', rows.length);
      
      if (rows.length > 0) {
        const firstRow = rows[0];
        const cells = firstRow.querySelectorAll('td');
        
        console.log('第一行数据验证:');
        console.log('- 标题:', cells[0] ? cells[0].textContent.trim() : 'N/A');
        console.log('- 会议室:', cells[1] ? cells[1].textContent.trim() : 'N/A');
        console.log('- 类型badge:', cells[2] ? cells[2].querySelector('.badge')?.textContent.trim() : 'N/A');
        console.log('- 参会人数原始:', cells[3] ? cells[3].textContent.trim() : 'N/A');
        console.log('- 参会人数清理后:', cells[3] ? cells[3].textContent.trim().replace(/\s*人\s*$/, '').replace(/^\s*\s*/, '').trim() : 'N/A');
        console.log('- 用户原始:', cells[4] ? cells[4].textContent.trim() : 'N/A');
        console.log('- 用户data属性:', firstRow.dataset.userOriginal || firstRow.dataset.user);
        console.log('- 开始时间:', cells[5] ? cells[5].textContent.trim() : 'N/A');
        console.log('- 结束时间:', cells[6] ? cells[6].textContent.trim() : 'N/A');
        console.log('- 状态badge:', cells[7] ? cells[7].querySelector('.badge')?.textContent.trim() : 'N/A');
      }
    }
    
    alert('数据验证完成，请查看控制台');
  }

  // 测试导出功能
  window.testExport = function() {
    const isTableView = document.getElementById('tableView').style.display !== 'none';
    console.log('当前视图模式:', isTableView ? '表格视图' : '卡片视图');
    
    let allItems, visibleItems;
    
    if (isTableView) {
      allItems = document.querySelectorAll('#reservationTableBody tr');
      visibleItems = Array.from(allItems).filter(item => 
        item.style.display !== 'none' && !item.classList.contains('d-none')
      );
    } else {
      allItems = document.querySelectorAll('.reservation-card');
      visibleItems = Array.from(allItems).filter(item => 
        item.style.display !== 'none' && !item.classList.contains('d-none')
      );
    }
    
    console.log('总项目数:', allItems.length);
    console.log('可见项目数:', visibleItems.length);
    
    if (visibleItems.length > 0) {
      console.log('第一个可见项目的HTML:', visibleItems[0].outerHTML.substring(0, 200) + '...');
      
      if (isTableView && visibleItems[0].querySelectorAll('td').length > 0) {
        const cells = visibleItems[0].querySelectorAll('td');
        console.log('表格列数:', cells.length);
        for (let i = 0; i < cells.length; i++) {
          console.log(`列 ${i}:`, cells[i].textContent.trim().substring(0, 50));
        }
      }
    }
    
    alert(`测试结果:\n总项目: ${allItems.length}\n可见项目: ${visibleItems.length}\n当前视图: ${isTableView ? '表格' : '卡片'}\n详细信息请查看控制台`);
  }

  // 批量操作功能（预留）
  window.toggleBatchActions = function() {
    const checkboxes = document.querySelectorAll('.reservation-checkbox');
    const batchActions = document.getElementById('batchActions');
    const hasChecked = Array.from(checkboxes).some(cb => cb.checked);
    
    if (batchActions) {
      batchActions.style.display = hasChecked ? 'block' : 'none';
    }
  }

  // 初始化过滤
  filterReservations();
});
</script>

<!-- 确认预约模态框 -->
<div class="modal fade" id="confirmReservationModal" tabindex="-1" aria-labelledby="confirmReservationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="confirmReservationModalLabel">
          <i class="fas fa-check-circle me-2"></i>确认预约
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
         
          <h6 class="mb-3">您确定要确认以下预约吗？</h6>
          <div class="alert alert-info">
            <strong id="confirmReservationTitle"></strong>
          </div>
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            确认后，预约状态将变更为已确认。
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>取消
        </button>
        <button type="button" class="btn btn-success" id="confirmReservationBtn">
          <i class="fas fa-check me-2"></i>确认预约
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>确认删除
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
          <h6 class="mb-3">您确定要删除以下预约吗？</h6>
          <div class="alert alert-warning">
            <strong id="deleteReservationTitle"></strong>
          </div>
          <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            此操作将永久删除该预约记录，且无法恢复。
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>取消
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash me-2"></i>确认删除
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 处理确认预约按钮
    document.querySelectorAll('.confirm-reservation-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const title = this.dataset.title;
            const url = this.dataset.url;
            confirmReservation(id, title, url);
        });
    });
    
    // 处理删除预约按钮
    document.querySelectorAll('.delete-reservation-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const title = this.dataset.title;
            const url = this.dataset.url;
            confirmDelete(title, url);
        });
    });
});

// 确认预约函数
function confirmReservation(id, title, url) {
    document.getElementById('confirmReservationTitle').textContent = title;
    document.getElementById('confirmReservationBtn').onclick = function() {
        window.location.href = url;
    };
    var modal = new bootstrap.Modal(document.getElementById('confirmReservationModal'));
    modal.show();
}

// 确认删除函数
function confirmDelete(title, url) {
    document.getElementById('deleteReservationTitle').textContent = title;
    document.getElementById('confirmDeleteBtn').onclick = function() {
        window.location.href = url;
    };
    var modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}
</script>
{% endblock %}
